{% extends 'base.html' %}
{% load static %}

{% block title %}Map - Mapping Early Modern Violence{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        /* ── Full-height two-zone layout ────────────────────────────── */
        .page-map-layout {
            display: flex;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        /* ── Sidebar ─────────────────────────────────────────────────── */
        .map-sidebar {
            width: 288px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            overflow: hidden;
        }

        /* Filter toggle button */
        .filter-toggle-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 16px;
            background: #8B4513;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            flex-shrink: 0;
            text-align: left;
        }

        .filter-toggle-btn:hover {
            background: #7a3c10;
        }

        .filter-caret {
            font-size: 10px;
            transition: transform 0.2s ease;
            line-height: 1;
        }

        /* Collapsed = triangle points down (rotate 180°) */
        .filter-caret.is-collapsed {
            transform: rotate(180deg);
        }

        /* Filter body — hidden by default */
        .filter-body {
            display: none;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #fafafa;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .filter-body.is-expanded {
            display: block;
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .filter-group label {
            display: block;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .filter-group select,
        .filter-group input[type="number"] {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
            background: white;
        }

        .filter-section-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
            margin: 12px 0 6px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        .filter-radio-row {
            display: flex;
            gap: 12px;
            margin-top: 4px;
        }

        .filter-radio-row label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: normal;
            font-size: 11px;
            text-transform: none;
            letter-spacing: 0;
            color: #374151;
            margin-bottom: 0;
            cursor: pointer;
        }

        .filter-action-btn {
            width: 100%;
            padding: 7px 10px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .filter-action-btn:hover {
            background: #5D2906;
        }

        .filter-action-btn.is-reset {
            background: #6b7280;
        }

        .filter-action-btn.is-reset:hover {
            background: #4b5563;
        }

        /* ── Case list ───────────────────────────────────────────────── */
        .case-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px 8px;
            flex-shrink: 0;
            border-bottom: 1px solid #f3f4f6;
        }

        #case-list-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
            margin: 0;
        }

        #back-btn {
            font-size: 11px;
            font-weight: 600;
            color: #8B4513;
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 0;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #back-btn:hover {
            color: #5D2906;
            text-decoration: underline;
        }

        .case-list-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .case-row {
            padding: 9px 16px;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.1s;
        }

        .case-row:hover {
            background: #fafafa;
        }

        .case-row-link {
            font-size: 13px;
            font-weight: 600;
            color: #0077be;
            text-decoration: none;
        }

        .case-row-link:hover {
            text-decoration: underline;
        }

        .case-row-type {
            font-size: 11px;
            color: #6b7280;
        }

        .case-row-meta {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .case-badge-fatal {
            display: inline-block;
            font-size: 9px;
            font-weight: 700;
            line-height: 1.4;
            padding: 0 6px;
            border-radius: 9999px;
            background: #fee2e2;
            color: #b91c1c;
            vertical-align: middle;
            margin-left: 3px;
        }

        .case-list-message {
            padding: 20px 16px;
            font-size: 12px;
            color: #9ca3af;
            text-align: center;
        }

        /* ── Map area ─────────────────────────────────────────────────── */
        .map-area {
            position: relative;
            flex: 1;
        }

        #map {
            position: absolute;
            inset: 0;
        }

        /* Legend */
        .legend-box {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 14px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 12px;
            color: #374151;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }

        .legend-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 7px;
            flex-shrink: 0;
        }

        /* Empty state overlay */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.92);
            padding: 20px 28px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            z-index: 999;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            pointer-events: none;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="page-map-layout">

        <!-- ── Sidebar ── -->
        <aside class="map-sidebar">

            <!-- Filter toggle (collapsed by default) -->
            <button class="filter-toggle-btn" id="filter-toggle" type="button">
                <span>Filters</span>
                <span class="filter-caret is-collapsed" id="filter-caret">&#9650;</span>
            </button>

            <!-- Filter body -->
            <div class="filter-body" id="filter-body">

                <div class="filter-group">
                    <label for="city-filter">City</label>
                    <select id="city-filter">
                        <option value="">All Cities</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="crime-type-filter">Crime Type</label>
                    <select id="crime-type-filter">
                        <option value="">All Crime Types</option>
                        {% for crime_type in crime_types %}
                            <option value="{{ crime_type }}">{{ crime_type }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="weapon-category-filter">Weapon Category</label>
                    <select id="weapon-category-filter">
                        <option value="">All Weapon Categories</option>
                        {% for value, label in weapon_categories %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="year-from-filter">Year From</label>
                    <input type="number" id="year-from-filter" placeholder="e.g. 1500" min="1400" max="2000">
                </div>

                <div class="filter-group">
                    <label for="year-to-filter">Year To</label>
                    <input type="number" id="year-to-filter" placeholder="e.g. 1700" min="1400" max="2000">
                </div>

                <div class="filter-section-label">Colour by</div>

                <div class="filter-group">
                    <label for="color-by-select">Visualization</label>
                    <select id="color-by-select">
                        <option value="none">None (default)</option>
                        <option value="crime_type">Crime Type</option>
                        <option value="fatality">Fatal / Non-fatal</option>
                        <option value="gender">Gender</option>
                    </select>
                </div>

                <div class="filter-group" id="gender-field-group" style="display:none">
                    <label>Gender of:</label>
                    <div class="filter-radio-row">
                        <label><input type="radio" name="gender_field" value="victim" checked> Victim</label>
                        <label><input type="radio" name="gender_field" value="perpetrator"> Perpetrator</label>
                    </div>
                </div>

                <button class="filter-action-btn" id="filter-action-btn" type="button">Apply Filters</button>

            </div>

            <!-- Case list header -->
            <div class="case-list-header">
                <h2 id="case-list-title">All Cases</h2>
                <button id="back-btn" type="button" style="display:none">&#8592; All cases</button>
            </div>

            <!-- Scrollable case list -->
            <div class="case-list-scroll" id="case-list">
                <div class="case-list-message">Loading&hellip;</div>
            </div>

        </aside>

        <!-- ── Map area ── -->
        <div class="map-area">
            <div id="map">
                <div id="empty-state" class="empty-state" style="display:none">
                    No violence events match the current filters.
                </div>
            </div>
            <div id="legend-box" class="legend-box" style="display:none"></div>
        </div>

    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        const crimeListUrl  = '{% url "crime_list" %}';
        const GENDER_LABELS = { M: "Male", F: "Female", U: "Unknown" };
        const GENDER_COLORS = { M: "#3b82f6", F: "#ec4899", U: "#6b7280" };
        const TYPE_PALETTE  = [
            "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00",
            "#a65628","#f781bf","#999999","#66c2a5","#fc8d62"
        ];
        let crimeTypeColorMap = {};
        let paletteIndex      = 0;
        let allLoadedCrimes   = [];

        // ── HTML escaping ─────────────────────────────────────────────────────
        function escHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // ── Sidebar case list ─────────────────────────────────────────────────
        function renderCaseList(crimes, locationName) {
            const titleEl = document.getElementById('case-list-title');
            const backBtn = document.getElementById('back-btn');
            const listEl  = document.getElementById('case-list');

            if (locationName) {
                titleEl.textContent = locationName;
                backBtn.style.display = 'block';
            } else {
                const n = crimes.length;
                titleEl.textContent = n + ' case' + (n !== 1 ? 's' : '');
                backBtn.style.display = 'none';
            }

            if (crimes.length === 0) {
                listEl.innerHTML = '<div class="case-list-message">No cases to display.</div>';
                return;
            }

            listEl.innerHTML = crimes.map(crime => {
                const caseLabel = crime.number
                    ? 'Case #' + escHtml(crime.number)
                    : 'Event #' + escHtml(String(crime.id));
                const type    = crime.crime          ? escHtml(crime.crime)          : '';
                const year    = crime.year           ? escHtml(String(crime.year))   : '';
                const city    = crime.city           ? escHtml(crime.city)           : '';
                const locName = crime.location_name  ? escHtml(crime.location_name)  : '';
                const fatal   = crime.fatality
                    ? '<span class="case-badge-fatal">Fatal</span>'
                    : '';
                const meta    = [year, locName, city].filter(Boolean).join(' · ');

                return '<div class="case-row">' +
                '<a class="case-row-link" href="/crime/' + crime.id + '/">' + caseLabel + '</a>' +
                (type  ? ' <span class="case-row-type">· ' + type + '</span>' : '') +
                fatal +
                (meta  ? '<div class="case-row-meta">' + meta + '</div>' : '') +
                '</div>';
            }).join('');
        }

        // ── Color helpers ─────────────────────────────────────────────────────
        function getCrimeTypeColor(type) {
            if (!type) return "#6b7280";
            if (!crimeTypeColorMap[type]) {
                crimeTypeColorMap[type] = TYPE_PALETTE[paletteIndex++ % TYPE_PALETTE.length];
            }
            return crimeTypeColorMap[type];
        }

        function getMarkerColor(crime, colorBy, genderField) {
            if (colorBy === "fatality")   return crime.fatality ? "#ef4444" : "#22c55e";
            if (colorBy === "gender")     return GENDER_COLORS[crime[genderField + "_gender"]] || "#6b7280";
            if (colorBy === "crime_type") return getCrimeTypeColor(crime.crime);
            return "#F59E0B";
        }

        function jitterCoords(lat, lng, index, total) {
            if (total <= 1) return [lat, lng];
            const angle  = (2 * Math.PI * index) / total;
            const radius = 0.002;
            return [lat + radius * Math.sin(angle), lng + radius * Math.cos(angle)];
        }

        // ── URL state ─────────────────────────────────────────────────────────
        function readUrlParams() {
            const p = new URLSearchParams(window.location.search);
            return {
                city:         p.get("city")         || "",
                crime_type:   p.get("crime_type")   || "",
                weapon_cat:   p.get("weapon_cat")   || "",
                year_from:    p.get("year_from")    || "",
                year_to:      p.get("year_to")      || "",
                color_by:     p.get("color_by")     || "none",
                gender_field: p.get("gender_field") || "victim",
            };
        }

        function pushUrlState(params) {
            const p = new URLSearchParams();
            Object.entries(params).forEach(([k, v]) => {
                if (v && v !== "none") p.set(k, v);
            });
            history.replaceState(null, "", "?" + p.toString());
        }

        // ── Legend ────────────────────────────────────────────────────────────
        function buildLegend(colorBy, genderField) {
            const box = document.getElementById("legend-box");
            if (colorBy === "none") { box.style.display = "none"; return; }

            let entries = [];
            if (colorBy === "fatality") {
                entries = [["#ef4444", "Fatal"], ["#22c55e", "Non-fatal"]];
            } else if (colorBy === "gender") {
                entries = Object.entries(GENDER_COLORS).map(([k, c]) => [c, GENDER_LABELS[k]]);
            } else if (colorBy === "crime_type") {
                entries = Object.entries(crimeTypeColorMap).map(([type, c]) => [c, type || "Unknown"]);
            }

            box.innerHTML = entries.map(([color, label]) =>
                '<div class="legend-item">' +
                '<span class="legend-dot" style="background:' + color + '"></span>' +
                escHtml(label) +
                '</div>'
            ).join("");
            box.style.display = "block";
        }

        // ── Map setup ─────────────────────────────────────────────────────────
        const map = L.map('map').setView([43.0, 12.0], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let markersLayer = null;

        // ── Load and render locations ─────────────────────────────────────────
        function loadLocations() {
            const city        = document.getElementById('city-filter').value;
            const crimeType   = document.getElementById('crime-type-filter').value;
            const weaponCat   = document.getElementById('weapon-category-filter').value;
            const yearFrom    = document.getElementById('year-from-filter').value;
            const yearTo      = document.getElementById('year-to-filter').value;
            const colorBy     = document.getElementById('color-by-select').value;
            const genderField = document.querySelector('input[name="gender_field"]:checked').value;

            pushUrlState({
                city,
                crime_type:   crimeType,
                weapon_cat:   weaponCat,
                year_from:    yearFrom,
                year_to:      yearTo,
                color_by:     colorBy,
                gender_field: genderField,
            });

            const params = new URLSearchParams();
            if (city)      params.append('city', city);
            if (crimeType) params.append('crime_type', crimeType);
            if (weaponCat) params.append('weapon_category', weaponCat);
            if (yearFrom)  params.append('year_from', yearFrom);
            if (yearTo)    params.append('year_to', yearTo);

            const url = '{% url "locations_geojson" %}' + (params.toString() ? '?' + params.toString() : '');

            if (markersLayer) { map.removeLayer(markersLayer); markersLayer = null; }

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const emptyState = document.getElementById('empty-state');

                    if (!data.features || data.features.length === 0) {
                        emptyState.style.display = 'block';
                        allLoadedCrimes = [];
                        renderCaseList([], null);
                        buildLegend("none", genderField);
                        return;
                    }
                    emptyState.style.display = 'none';

                    // Reset color palette for fresh color assignments
                    crimeTypeColorMap = {};
                    paletteIndex = 0;

                    // Flatten all crimes for the sidebar "all cases" view
                    allLoadedCrimes = [];
                    data.features.forEach(feature => {
                        const crimes = feature.properties.crimes || [];
                        crimes.forEach(crime => {
                            allLoadedCrimes.push(Object.assign({}, crime, {
                                location_name: feature.properties.name,
                                city:          feature.properties.city,
                            }));
                        });
                    });
                    // Sort descending by date then year
                    allLoadedCrimes.sort((a, b) => {
                        const da = a.date || (a.year ? String(a.year) : '');
                        const db = b.date || (b.year ? String(b.year) : '');
                        return db.localeCompare(da);
                    });
                    renderCaseList(allLoadedCrimes, null);

                    if (colorBy === "none") {
                        // Default mode: location-level markers sized by crime count
                        markersLayer = L.geoJSON(data, {
                            pointToLayer: (feature, latlng) => {
                                const count  = feature.properties.crime_count || 1;
                                const radius = Math.min(6 + (count * 2), 20);
                                return L.circleMarker(latlng, {
                                    radius:      radius,
                                    fillColor:   "#F59E0B",
                                    color:       "#FBBF24",
                                    weight:      2,
                                    opacity:     1,
                                    fillOpacity: 0.8
                                });
                            },
                            onEachFeature: (feature, layer) => {
                                const n = feature.properties.crime_count || 0;
                                layer.bindTooltip(
                                    '<strong>' + escHtml(feature.properties.name || '') + '</strong>' +
                                    '<br><span style="color:#6b7280;">' +
                                    n + ' case' + (n !== 1 ? 's' : '') +
                                    '</span>',
                                    { sticky: true, direction: 'top' }
                                );
                                layer.on('click', () => {
                                    const locCrimes = (feature.properties.crimes || []).map(c =>
                                        Object.assign({}, c, {
                                            location_name: feature.properties.name,
                                            city:          feature.properties.city,
                                        })
                                    );
                                    renderCaseList(locCrimes, feature.properties.name);
                                });
                            }
                        }).addTo(map);

                    } else {
                        // Color-by mode: individual jittered markers per crime
                        markersLayer = L.layerGroup().addTo(map);

                        data.features.forEach(feature => {
                            const crimes  = feature.properties.crimes || [];
                            const baseLat = feature.geometry.coordinates[1];
                            const baseLng = feature.geometry.coordinates[0];
                            const total   = crimes.length;

                            crimes.forEach((crime, index) => {
                                const [lat, lng] = jitterCoords(baseLat, baseLng, index, total);
                                const color = getMarkerColor(crime, colorBy, genderField);

                                const marker = L.circleMarker([lat, lng], {
                                    radius:      7,
                                    fillColor:   color,
                                    color:       "#fff",
                                    weight:      1.5,
                                    opacity:     1,
                                    fillOpacity: 0.85
                                });

                                marker.bindTooltip(
                                    '<strong>' + escHtml(feature.properties.name || '') + '</strong>' +
                                    (crime.crime ? '<br>' + escHtml(crime.crime) : ''),
                                    { sticky: true, direction: 'top' }
                                );

                                marker.on('click', () => {
                                    const enriched = Object.assign({}, crime, {
                                        location_name: feature.properties.name,
                                        city:          feature.properties.city,
                                    });
                                    renderCaseList([enriched], feature.properties.name);
                                });

                                marker.addTo(markersLayer);
                            });
                        });
                    }

                    buildLegend(colorBy, genderField);
                })
                .catch(err => console.error('Error loading location data:', err));
        }

        // ── Back button ───────────────────────────────────────────────────────
        document.getElementById('back-btn').addEventListener('click', () => {
            renderCaseList(allLoadedCrimes, null);
        });

        // ── Filter panel toggle ───────────────────────────────────────────────
        document.getElementById('filter-toggle').addEventListener('click', () => {
            document.getElementById('filter-body').classList.toggle('is-expanded');
            document.getElementById('filter-caret').classList.toggle('is-collapsed');
        });

        // ── Color-by: show/hide gender sub-option and auto-apply ─────────────
        document.getElementById('color-by-select').addEventListener('change', function () {
            document.getElementById('gender-field-group').style.display =
                this.value === 'gender' ? 'block' : 'none';
            loadLocations();
        });

        // ── Gender radio: auto-apply when changed ─────────────────────────────
        document.querySelectorAll('input[name="gender_field"]').forEach(radio => {
            radio.addEventListener('change', () => loadLocations());
        });

        // ── Apply / Reset button ──────────────────────────────────────────────
        const filterInputIds = [
            'city-filter',
            'crime-type-filter',
            'weapon-category-filter',
            'year-from-filter',
            'year-to-filter',
        ];
        const filterBtn = document.getElementById('filter-action-btn');
        let filtersApplied = false;

        function hasActiveFilters() {
            return filterInputIds.some(id => document.getElementById(id).value !== '');
        }

        function clearFilters() {
            filterInputIds.forEach(id => { document.getElementById(id).value = ''; });
            document.getElementById('color-by-select').value = 'none';
            document.getElementById('gender-field-group').style.display = 'none';
            const radio = document.querySelector('input[name="gender_field"][value="victim"]');
            if (radio) radio.checked = true;
        }

        filterBtn.addEventListener('click', () => {
            if (filtersApplied) {
                clearFilters();
                loadLocations();
                filtersApplied = false;
                filterBtn.textContent = 'Apply Filters';
                filterBtn.classList.remove('is-reset');
            } else {
                loadLocations();
                if (hasActiveFilters()) {
                    filtersApplied = true;
                    filterBtn.textContent = 'Reset Filters';
                    filterBtn.classList.add('is-reset');
                }
            }
        });

        // ── Restore URL state and initial load ────────────────────────────────
        (function initFromUrl() {
            const p = readUrlParams();

            if (p.city)       document.getElementById('city-filter').value = p.city;
            if (p.crime_type) document.getElementById('crime-type-filter').value = p.crime_type;
            if (p.weapon_cat) document.getElementById('weapon-category-filter').value = p.weapon_cat;
            if (p.year_from)  document.getElementById('year-from-filter').value = p.year_from;
            if (p.year_to)    document.getElementById('year-to-filter').value = p.year_to;

            document.getElementById('color-by-select').value = p.color_by;
            if (p.color_by === 'gender') {
                document.getElementById('gender-field-group').style.display = 'block';
            }

            const radio = document.querySelector('input[name="gender_field"][value="' + p.gender_field + '"]');
            if (radio) radio.checked = true;

            loadLocations();
        })();
    </script>
{% endblock %}
