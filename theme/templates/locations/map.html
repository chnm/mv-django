{% extends 'base.html' %}
{% load static %}

{% block title %}Map - Mapping Early Modern Violence{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        .map-container {
            position: relative;
            height: calc(100vh - 80px);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Filter panel */
        .filter-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
            width: 260px;
            overflow: hidden;
        }

        /* Clickable header with integrated caret */
        .filter-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            cursor: pointer;
            user-select: none;
            background: #8B4513;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .filter-panel-header:hover {
            background: #7a3c10;
        }

        .filter-panel-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .filter-caret {
            font-size: 11px;
            transition: transform 0.25s ease;
            line-height: 1;
        }

        .filter-panel.panel-collapsed .filter-caret {
            transform: rotate(180deg);
        }

        /* Collapsible body */
        .filter-panel-body {
            padding: 16px 20px 20px;
            max-height: 800px;
            overflow: hidden;
            transition: max-height 0.25s ease, padding 0.25s ease;
        }

        .filter-panel.panel-collapsed .filter-panel-body {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .filter-section-header {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
            margin: 16px 0 8px 0;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .filter-panel .filter-group {
            margin-bottom: 15px;
        }

        .filter-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .filter-panel select,
        .filter-panel input:not([type="radio"]):not([type="checkbox"]) {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .filter-panel button {
            width: 100%;
            padding: 10px;
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .filter-panel button:hover {
            background-color: #5D2906;
        }

        .filter-panel button.reset {
            background-color: #6b7280;
        }

        .filter-panel button.reset:hover {
            background-color: #4b5563;
        }

        /* Gender sub-option radio labels */
        #gender-field-group .radio-row {
            display: flex;
            gap: 16px;
            margin-top: 4px;
        }

        #gender-field-group .radio-row label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
            margin-bottom: 0;
            cursor: pointer;
        }

        /* Legend box */
        .legend-box {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 140px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }

        .legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* Empty state overlay */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.92);
            padding: 24px 32px;
            border-radius: 10px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.2);
            z-index: 999;
            font-size: 16px;
            font-weight: 500;
            color: #374151;
            text-align: center;
            pointer-events: none;
        }

        /* Popup styles */
        .leaflet-popup-content {
            font-size: 14px;
            max-width: 300px;
        }

        .leaflet-popup-content h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .leaflet-popup-content p {
            margin: 5px 0;
        }

        .leaflet-popup-content .label {
            font-weight: 600;
            color: #374151;
        }

        /* Drawer Styles */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .drawer {
            position: fixed;
            background: white;
            z-index: 2001;
            overflow-y: auto;
            box-shadow: -2px 0 8px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        /* Desktop: slide from left */
        @media (min-width: 768px) {
            .drawer {
                top: 0;
                left: 0;
                bottom: 0;
                width: 400px;
            }
        }

        /* Mobile: slide from bottom */
        @media (max-width: 767px) {
            .drawer {
                left: 0;
                right: 0;
                bottom: 0;
                max-height: 80vh;
            }
        }

        .drawer-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 20px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .drawer-content {
            padding: 20px;
        }

        .close-drawer {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .close-drawer:hover {
            background: #4b5563;
        }

        .drawer h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }

        .drawer .info-item {
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .drawer .info-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drawer .info-value {
            color: #1f2937;
            font-size: 16px;
            margin-top: 4px;
        }

        .drawer .crimes-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .drawer .crimes-header {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 15px;
        }

        .drawer .crime-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .drawer .crime-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .drawer .crime-card a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 600;
        }

        .drawer .crime-card a:hover {
            color: #1e40af;
            text-decoration: underline;
        }

        .drawer .crime-type {
            color: #4b5563;
            font-size: 14px;
            margin-top: 4px;
        }

        .crime-filter-link {
            color: #8B4513;
            text-decoration: none;
            font-weight: 500;
        }

        .crime-filter-link:hover {
            color: #5D2906;
            text-decoration: underline;
        }

        .drawer .crime-year {
            color: #6b7280;
            font-size: 13px;
            font-style: italic;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="map-container" x-data="locationDrawer()">

        <!-- Filter panel with integrated header toggle -->
        <div class="filter-panel" id="filter-panel">

            <div class="filter-panel-header" id="filter-toggle">
                <h3>Filter Crimes</h3>
                <span class="filter-caret">&#9650;</span>
            </div>

            <div class="filter-panel-body">
                <div class="filter-group">
                    <label for="city-filter">City</label>
                    <select id="city-filter">
                        <option value="">All Cities</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="crime-type-filter">Crime Type</label>
                    <select id="crime-type-filter">
                        <option value="">All Crime Types</option>
                        {% for crime_type in crime_types %}
                            <option value="{{ crime_type }}">{{ crime_type }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="weapon-category-filter">Weapon Category</label>
                    <select id="weapon-category-filter">
                        <option value="">All Weapon Categories</option>
                        {% for value, label in weapon_categories %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="year-from-filter">Year From</label>
                    <input type="number" id="year-from-filter" placeholder="e.g., 1500" min="1400" max="2000">
                </div>

                <div class="filter-group">
                    <label for="year-to-filter">Year To</label>
                    <input type="number" id="year-to-filter" placeholder="e.g., 1700" min="1400" max="2000">
                </div>

                <!-- Color by section -->
                <div class="filter-section-header">Color by</div>

                <div class="filter-group">
                    <label for="color-by-select">Visualization</label>
                    <select id="color-by-select">
                        <option value="none">None (default)</option>
                        <option value="crime_type">Crime Type</option>
                        <option value="fatality">Fatal / Non-fatal</option>
                        <option value="gender">Gender</option>
                    </select>
                </div>

                <!-- Gender sub-option, shown only when color-by=gender -->
                <div class="filter-group" id="gender-field-group" style="display:none">
                    <label>Gender of:</label>
                    <div class="radio-row">
                        <label><input type="radio" name="gender_field" value="victim" checked> Victim</label>
                        <label><input type="radio" name="gender_field" value="perpetrator"> Perpetrator</label>
                    </div>
                </div>

                <button id="filter-action-btn">Apply Filters</button>
            </div>
        </div>

        <div id="map">
            <!-- Empty state overlay -->
            <div id="empty-state" class="empty-state" style="display:none">
                No violence events match the current filters.
            </div>
        </div>

        <!-- Legend box -->
        <div id="legend-box" class="legend-box" style="display:none"></div>

        <!-- Drawer Overlay -->
        <div x-show="isOpen"
             x-transition.opacity
             @click="close()"
             class="drawer-overlay"></div>

        <!-- Drawer -->
        <div class="drawer"
             x-show="isOpen"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="transform -translate-x-full md:translate-y-0 md:-translate-x-full translate-y-full"
             x-transition:enter-end="transform translate-x-0 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="transform translate-x-0 translate-y-0"
             x-transition:leave-end="transform -translate-x-full md:translate-y-0 md:-translate-x-full translate-y-full">

            <div class="drawer-header">
                <h2 x-text="location.name"></h2>
                <button @click="close()" class="close-drawer">Close</button>
            </div>

            <div class="drawer-content">
                <!-- Location Information -->
                <template x-if="location.city">
                    <div class="info-item">
                        <div class="info-label">City</div>
                        <div class="info-value" x-text="location.city"></div>
                    </div>
                </template>

                <template x-if="location.category">
                    <div class="info-item">
                        <div class="info-label">Category</div>
                        <div class="info-value" x-text="location.category"></div>
                    </div>
                </template>

                <template x-if="location.current_name">
                    <div class="info-item">
                        <div class="info-label">Current Name</div>
                        <div class="info-value" x-text="location.current_name"></div>
                    </div>
                </template>

                <!-- Crimes Section -->
                <template x-if="location.crimes && location.crimes.length > 0">
                    <div class="crimes-section">
                        <div class="crimes-header">
                            Crimes at this location (<span x-text="location.crime_count"></span>)
                        </div>

                        <template x-for="crime in location.crimes" :key="crime.id">
                            <div class="crime-card">
                                <a :href="'/crime/' + crime.id + '/'" x-html="formatCrimeTitle(crime)"></a>
                                <div class="crime-type" x-show="crime.crime">
                                    <a :href="crimeListUrl + '?crime=' + encodeURIComponent(crime.crime)"
                                       x-text="crime.crime"
                                       class="crime-filter-link"></a>
                                </div>
                                <div class="crime-year" x-show="crime.year" x-text="'Year: ' + crime.year"></div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        const crimeListUrl  = '{% url "crime_list" %}';
        const GENDER_LABELS = { M: "Male", F: "Female", U: "Unknown" };
        const GENDER_COLORS = { M: "#3b82f6", F: "#ec4899", U: "#6b7280" };
        const FATALITY_COLORS = { true: "#ef4444", false: "#22c55e" };
        const TYPE_PALETTE = [
            "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00",
            "#a65628","#f781bf","#999999","#66c2a5","#fc8d62"
        ];
        let crimeTypeColorMap = {};
        let paletteIndex = 0;

        // ── Global drawer controller ──────────────────────────────────────────
        window.drawerController = null;

        function locationDrawer() {
            return {
                isOpen: false,
                location: {
                    name: '',
                    city: '',
                    category: '',
                    current_name: '',
                    crime_count: 0,
                    crimes: []
                },

                init() {
                    window.drawerController = this;
                },

                open(locationData) {
                    this.location = locationData;
                    this.isOpen = true;
                    document.body.style.overflow = 'hidden';
                },

                close() {
                    this.isOpen = false;
                    document.body.style.overflow = 'auto';
                },

                formatCrimeTitle(crime) {
                    if (crime.number) {
                        return '<strong>Case #' + crime.number + '</strong>';
                    }
                    return 'View Crime Details';
                }
            };
        }

        // ── Color helpers ─────────────────────────────────────────────────────
        function getCrimeTypeColor(type) {
            if (!type) return "#6b7280";
            if (!crimeTypeColorMap[type]) {
                crimeTypeColorMap[type] = TYPE_PALETTE[paletteIndex++ % TYPE_PALETTE.length];
            }
            return crimeTypeColorMap[type];
        }

        function getMarkerColor(crime, colorBy, genderField) {
            if (colorBy === "fatality")   return crime.fatality ? "#ef4444" : "#22c55e";
            if (colorBy === "gender")     return GENDER_COLORS[crime[genderField + "_gender"]] || "#6b7280";
            if (colorBy === "crime_type") return getCrimeTypeColor(crime.crime);
            return "#F59E0B"; // default amber
        }

        function jitterCoords(lat, lng, index, total) {
            if (total <= 1) return [lat, lng];
            const angle  = (2 * Math.PI * index) / total;
            const radius = 0.002;
            return [lat + radius * Math.sin(angle), lng + radius * Math.cos(angle)];
        }

        // ── URL state ─────────────────────────────────────────────────────────
        function readUrlParams() {
            const p = new URLSearchParams(window.location.search);
            return {
                city:         p.get("city")          || "",
                crime_type:   p.get("crime_type")    || "",
                weapon_cat:   p.get("weapon_cat")    || "",
                year_from:    p.get("year_from")     || "",
                year_to:      p.get("year_to")       || "",
                color_by:     p.get("color_by")      || "none",
                gender_field: p.get("gender_field")  || "victim",
            };
        }

        function pushUrlState(params) {
            const p = new URLSearchParams();
            Object.entries(params).forEach(([k, v]) => {
                if (v && v !== "none") p.set(k, v);
            });
            history.replaceState(null, "", "?" + p.toString());
        }

        // ── Legend ────────────────────────────────────────────────────────────
        function buildLegend(colorBy, genderField) {
            const box = document.getElementById("legend-box");
            if (colorBy === "none") { box.style.display = "none"; return; }

            let entries = [];
            if (colorBy === "fatality") {
                entries = [["#ef4444", "Fatal"], ["#22c55e", "Non-fatal"]];
            } else if (colorBy === "gender") {
                entries = Object.entries(GENDER_COLORS).map(([k, c]) => [c, GENDER_LABELS[k]]);
            } else if (colorBy === "crime_type") {
                entries = Object.entries(crimeTypeColorMap).map(([type, c]) => [c, type || "Unknown"]);
            }

            box.innerHTML = entries.map(([color, label]) =>
                '<div class="legend-item">' +
                '<span class="legend-dot" style="background:' + color + '"></span>' +
                label +
                '</div>'
            ).join("");
            box.style.display = "block";
        }

        // ── Map setup ─────────────────────────────────────────────────────────
        const map = L.map('map').setView([43.0, 12.0], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let markersLayer = null;

        // ── Load locations ────────────────────────────────────────────────────
        function loadLocations() {
            const city          = document.getElementById('city-filter').value;
            const crimeType     = document.getElementById('crime-type-filter').value;
            const weaponCat     = document.getElementById('weapon-category-filter').value;
            const yearFrom      = document.getElementById('year-from-filter').value;
            const yearTo        = document.getElementById('year-to-filter').value;
            const colorBy       = document.getElementById('color-by-select').value;
            const genderField   = document.querySelector('input[name="gender_field"]:checked').value;

            // Persist all state to URL (color-by is client-side only, not sent to API)
            pushUrlState({
                city,
                crime_type: crimeType,
                weapon_cat: weaponCat,
                year_from:  yearFrom,
                year_to:    yearTo,
                color_by:   colorBy,
                gender_field: genderField,
            });

            // Build GeoJSON API query (no color-by — it's client-side)
            const params = new URLSearchParams();
            if (city)        params.append('city', city);
            if (crimeType)   params.append('crime_type', crimeType);
            if (weaponCat)   params.append('weapon_category', weaponCat);
            if (yearFrom)    params.append('year_from', yearFrom);
            if (yearTo)      params.append('year_to', yearTo);

            const url = '{% url "locations_geojson" %}' + (params.toString() ? '?' + params.toString() : '');

            if (markersLayer) {
                map.removeLayer(markersLayer);
                markersLayer = null;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const emptyState = document.getElementById('empty-state');

                    if (!data.features || data.features.length === 0) {
                        emptyState.style.display = 'block';
                        buildLegend("none", genderField);
                        return;
                    }
                    emptyState.style.display = 'none';

                    // Reset color palette for consistent colors per load
                    crimeTypeColorMap = {};
                    paletteIndex = 0;

                    if (colorBy === "none") {
                        // Default: location-level markers sized by crime count
                        markersLayer = L.geoJSON(data, {
                            pointToLayer: function (feature, latlng) {
                                const crimeCount = feature.properties.crime_count || 1;
                                const radius = Math.min(6 + (crimeCount * 2), 20);
                                return L.circleMarker(latlng, {
                                    radius: radius,
                                    fillColor: "#F59E0B",
                                    color: "#FBBF24",
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                });
                            },
                            onEachFeature: function (feature, layer) {
                                layer.on('click', function () {
                                    if (window.drawerController) {
                                        window.drawerController.open(feature.properties);
                                    }
                                });
                            }
                        }).addTo(map);
                    } else {
                        // Color-by mode: individual jittered markers per crime
                        markersLayer = L.layerGroup().addTo(map);

                        data.features.forEach(function (feature) {
                            const crimes = feature.properties.crimes || [];
                            const baseLat = feature.geometry.coordinates[1];
                            const baseLng = feature.geometry.coordinates[0];
                            const total   = crimes.length;

                            crimes.forEach(function (crime, index) {
                                const [lat, lng] = jitterCoords(baseLat, baseLng, index, total);
                                const color = getMarkerColor(crime, colorBy, genderField);

                                const marker = L.circleMarker([lat, lng], {
                                    radius: 7,
                                    fillColor: color,
                                    color: "#fff",
                                    weight: 1.5,
                                    opacity: 1,
                                    fillOpacity: 0.85
                                });

                                // Drawer data: single-crime view using location properties
                                marker.on('click', function () {
                                    if (window.drawerController) {
                                        const drawerData = Object.assign({}, feature.properties, {
                                            crimes: [crime],
                                            crime_count: 1,
                                        });
                                        window.drawerController.open(drawerData);
                                    }
                                });

                                marker.addTo(markersLayer);
                            });
                        });
                    }

                    buildLegend(colorBy, genderField);
                })
                .catch(function (error) {
                    console.error('Error loading location data:', error);
                });
        }

        // ── Restore state from URL and load ───────────────────────────────────
        (function initFromUrl() {
            const p = readUrlParams();

            // Restore filter inputs
            if (p.city)       document.getElementById('city-filter').value = p.city;
            if (p.crime_type) document.getElementById('crime-type-filter').value = p.crime_type;
            if (p.weapon_cat) document.getElementById('weapon-category-filter').value = p.weapon_cat;
            if (p.year_from)  document.getElementById('year-from-filter').value = p.year_from;
            if (p.year_to)    document.getElementById('year-to-filter').value = p.year_to;

            // Restore color-by
            document.getElementById('color-by-select').value = p.color_by;
            if (p.color_by === 'gender') {
                document.getElementById('gender-field-group').style.display = 'block';
            }

            // Restore gender_field radio
            const radio = document.querySelector('input[name="gender_field"][value="' + p.gender_field + '"]');
            if (radio) radio.checked = true;

            loadLocations();
        })();

        // ── Filter toggle (header click) ──────────────────────────────────────
        document.getElementById('filter-toggle').addEventListener('click', function () {
            document.getElementById('filter-panel').classList.toggle('panel-collapsed');
        });

        // ── Color-by select ───────────────────────────────────────────────────
        document.getElementById('color-by-select').addEventListener('change', function () {
            document.getElementById('gender-field-group').style.display =
                this.value === 'gender' ? 'block' : 'none';
        });

        // ── Apply / Reset button ──────────────────────────────────────────────
        const filterIds = [
            'city-filter',
            'crime-type-filter',
            'weapon-category-filter',
            'year-from-filter',
            'year-to-filter',
        ];
        const filterBtn = document.getElementById('filter-action-btn');
        let filtersApplied = false;

        function hasActiveFilters() {
            return filterIds.some(id => document.getElementById(id).value !== '');
        }

        function clearFilters() {
            filterIds.forEach(id => { document.getElementById(id).value = ''; });
            document.getElementById('color-by-select').value = 'none';
            document.getElementById('gender-field-group').style.display = 'none';
            const victimRadio = document.querySelector('input[name="gender_field"][value="victim"]');
            if (victimRadio) victimRadio.checked = true;
        }

        filterBtn.addEventListener('click', function () {
            if (filtersApplied) {
                clearFilters();
                loadLocations();
                filtersApplied = false;
                filterBtn.textContent = 'Apply Filters';
                filterBtn.classList.remove('reset');
            } else {
                loadLocations();
                if (hasActiveFilters()) {
                    filtersApplied = true;
                    filterBtn.textContent = 'Reset Filters';
                    filterBtn.classList.add('reset');
                }
            }
        });
    </script>
{% endblock %}
