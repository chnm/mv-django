{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if crime.number %}Case #{{ crime.number }}{% else %}Crime Detail{% endif %} - Mapping Early Modern Violence
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        #crime-map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="bg-white-50 py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
            <div class="mb-8">
                <a href="{% url 'crime_list' %}" class="text-mediterranean-600 hover:text-mediterranean-800 text-base mb-4 inline-block">&larr; Back to Data</a>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2">
                    {% if crime.number %}
                        Case #{{ crime.number }}
                    {% else %}
                        Crime Detail
                    {% endif %}
                </h1>
                {% if crime.crime %}
                    <p class="text-xl">
                        <a href="{% url 'crime_list' %}?crime={{ crime.crime|urlencode }}"
                           class="hover:underline"
                           style="color: #8B4513;">{{ crime.crime }}</a>
                    </p>
                {% endif %}
            </div>

        <!-- Case Description -->
            {% if crime.description_of_case %}
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Case Description</h2>
                    <p class="text-gray-700 leading-relaxed">{{ crime.description_of_case }}</p>
                </div>
            {% endif %}

            <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Date and Time Information -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Date & Time</h2>
                    <dl class="space-y-2">
                        {% if crime.date %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Date</dt>
                                <dd class="text-base text-gray-900">{{ crime.date }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.year %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Year</dt>
                                <dd class="text-base text-gray-900">{{ crime.year }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.day_of_week %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Day of Week</dt>
                                <dd class="text-base text-gray-900">{{ crime.day_of_week }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.time %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Time</dt>
                                <dd class="text-base text-gray-900">{{ crime.time }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.liturgical_occasion %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Liturgical Occasion</dt>
                                <dd class="text-base text-gray-900">{{ crime.liturgical_occasion }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.connected_event %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Connected Event</dt>
                                <dd class="text-base text-gray-900">{{ crime.connected_event.name }}</dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>

            <!-- Location Information -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Location</h2>
                    <dl class="space-y-2">
                        {% if crime.address %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Address</dt>
                                <dd class="text-base text-gray-900">{{ crime.address.name }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.address.city %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">City</dt>
                                <dd class="text-base text-gray-900">{{ crime.address.city.name }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.sestiere %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Sestiere</dt>
                                <dd class="text-base text-gray-900">{{ crime.sestiere }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.description_of_location %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Location Description</dt>
                                <dd class="text-base text-gray-900">{{ crime.description_of_location }}</dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- People Involved -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">People Involved</h2>

                    {% if crime.victim.all %}
                        <div class="mb-4">
                            <h3 class="text-base font-semibold text-gray-700 mb-2">Victim(s)</h3>
                            <ul class="list-disc list-inside text-gray-900">
                                {% for person in crime.victim.all %}
                                    <li>{{ person }}</li>
                                {% endfor %}
                            </ul>
                            {% if crime.victim_description %}
                                <p class="text-sm text-gray-600 mt-2">{{ crime.victim_description }}</p>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if crime.perpetrator.all %}
                        <div class="mb-4">
                            <h3 class="text-base font-semibold text-gray-700 mb-2">Perpetrator(s)</h3>
                            <ul class="list-disc list-inside text-gray-900">
                                {% for person in crime.perpetrator.all %}
                                    <li>{{ person }}</li>
                                {% endfor %}
                            </ul>
                            {% if crime.assailant_description %}
                                <p class="text-sm text-gray-600 mt-2">{{ crime.assailant_description }}</p>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if crime.relationship %}
                        <div>
                            <dt class="text-sm font-medium text-gray-600">Relationship</dt>
                            <dd class="text-base text-gray-900">{{ crime.relationship }}</dd>
                        </div>
                    {% endif %}
                </div>

            <!-- Crime Details -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Crime Details</h2>
                    <dl class="space-y-2">
                        {% if crime.weapon %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Weapon</dt>
                                <dd class="text-base text-gray-900">{{ crime.weapon.name }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.motive %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Motive</dt>
                                <dd class="text-base text-gray-900">{{ crime.motive }}</dd>
                            </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium text-gray-600">Fatality</dt>
                            <dd class="text-base text-gray-900">{% if crime.fatality %}Yes{% else %}No{% endif %}</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
        <!-- Legal Information -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Legal Information</h2>
                    <dl class="space-y-2">
                        {% if crime.court %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Court</dt>
                                <dd class="text-base text-gray-900">{{ crime.court }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.court_classification %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Court Classification</dt>
                                <dd class="text-base text-gray-900">{{ crime.court_classification }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.trial_phase %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Trial Phase</dt>
                                <dd class="text-base text-gray-900">{{ crime.trial_phase }}</dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>

        <!-- Sentencing -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Sentencing</h2>
                    <dl class="space-y-2">
                        {% if crime.sentence %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Sentence</dt>
                                <dd class="text-base text-gray-900">{{ crime.sentence }}</dd>
                            </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium text-gray-600">In Contumacia</dt>
                            <dd class="text-base text-gray-900">{% if crime.sentence_in_absentia %}Yes{% else %}No{% endif %}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-600">Sentence Enforced</dt>
                            <dd class="text-base text-gray-900">{% if crime.sentence_enforced %}Yes{% else %}No{% endif %}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-600">Convicted</dt>
                            <dd class="text-base text-gray-900">{% if crime.convicted %}Yes{% else %}No{% endif %}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-600">Pardoned</dt>
                            <dd class="text-base text-gray-900">{% if crime.pardoned %}Yes{% else %}No{% endif %}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-600">Arbitration</dt>
                            <dd class="text-base text-gray-900">{% if crime.arbitration %}Yes{% else %}No{% endif %}</dd>
                        </div>
                        {% if crime.accord %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Peace Accord</dt>
                                <dd class="text-base text-gray-900">Yes{% if crime.accord_date %} ({{ crime.accord_date }}){% endif %}</dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>
            </div>

        <!-- Location Map -->
            {% if crime.address.effective_latitude and crime.address.effective_longitude %}
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div id="crime-map"></div>
                </div>
            {% endif %}

        <!-- Archival Information -->
            {% if crime.source or crime.archival_location or crime.reference %}
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Sources</h2>
                    <dl class="space-y-2">
                        {% if crime.source %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Source</dt>
                                <dd class="text-base text-gray-900">{{ crime.source }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.archival_location %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Archival Location</dt>
                                <dd class="text-base text-gray-900">{{ crime.archival_location }}</dd>
                            </div>
                        {% endif %}
                        {% if crime.reference %}
                            <div>
                                <dt class="text-sm font-medium text-gray-600">Reference</dt>
                                <dd class="text-base text-gray-900">{{ crime.reference }}</dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {% if crime.address.effective_latitude and crime.address.effective_longitude %}
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>
        <script>
    // Initialize the map centered on the crime location
            const crimeMap = L.map('crime-map').setView([{{ crime.address.effective_latitude }}, {{ crime.address.effective_longitude }}], 15);

    // Add CartoDB Dark Matter tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(crimeMap);

    // Add marker for crime location
            const marker = L.circleMarker([{{ crime.address.effective_latitude }}, {{ crime.address.effective_longitude }}], {
                radius: 8,
                fillColor: "#F59E0B",
                color: "#FBBF24",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(crimeMap);

    // Add popup to marker
            let popupContent = '<div style="color: #1f2937;">';
            popupContent += '<strong>{{ crime.address.name }}</strong><br>';
            {% if crime.address.city %}
                popupContent += '{{ crime.address.city.name }}<br>';
            {% endif %}
            {% if crime.crime %}
                popupContent += '<em>{{ crime.crime }}</em>';
            {% endif %}
            popupContent += '</div>';

            marker.bindPopup(popupContent);
        </script>
    {% endif %}
{% endblock %}
